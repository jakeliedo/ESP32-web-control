{% extends 'layout.html' %}

{% block title %}Analytics - WC Control System{% endblock %}

{% block content %}
<!-- Analytics Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-6 fw-bold mb-2">
                    <i class="bi bi-graph-up me-3"></i>System Analytics
                </h1>
                <p class="text-muted mb-0">Comprehensive insights and performance metrics</p>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="time-range" style="width: auto;">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshAnalytics()" data-bs-toggle="tooltip" title="Refresh Data">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
                <a href="/" class="btn btn-primary btn-sm">
                    <i class="bi bi-speedometer2 me-1"></i>Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="text-center">
                <div class="stat-number text-primary" id="total-commands">0</div>
                <div class="stat-label">Total Commands</div>
                <small class="text-muted">All time</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="text-center">
                <div class="stat-number text-success" id="successful-commands">0</div>
                <div class="stat-label">Successful</div>
                <small class="text-success">98.5% success rate</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="text-center">
                <div class="stat-number text-info" id="avg-response-time">45ms</div>
                <div class="stat-label">Avg Response</div>
                <small class="text-muted">Response time</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="text-center">
                <div class="stat-number text-warning" id="peak-usage">156</div>
                <div class="stat-label">Peak Usage</div>
                <small class="text-muted">Commands/hour</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="text-center">
                <div class="stat-number text-info" id="uptime">99.8%</div>
                <div class="stat-label">System Uptime</div>
                <small class="text-success">Excellent</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="text-center">
                <div class="stat-number text-secondary" id="active-sessions">8</div>
                <div class="stat-label">Active Sessions</div>
                <small class="text-muted">Currently connected</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="chart-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-activity me-2"></i>System Activity Timeline
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="activity-chart-type" id="commands" checked>
                    <label class="btn btn-outline-primary" for="commands">Commands</label>
                    
                    <input type="radio" class="btn-check" name="activity-chart-type" id="connections">
                    <label class="btn btn-outline-primary" for="connections">Connections</label>
                    
                    <input type="radio" class="btn-check" name="activity-chart-type" id="errors">
                    <label class="btn btn-outline-primary" for="errors">Errors</label>
                </div>
            </div>
            <canvas id="activityTimelineChart" height="80"></canvas>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="bi bi-pie-chart me-2"></i>Node Usage Distribution
            </h5>
            <canvas id="nodeUsageChart" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="bi bi-bar-chart me-2"></i>Hourly Usage Pattern
            </h5>
            <canvas id="hourlyUsageChart" height="120"></canvas>
        </div>
    </div>
    
    <div class="col-lg-6 mb-3">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="bi bi-speedometer me-2"></i>Response Time Distribution
            </h5>
            <canvas id="responseTimeChart" height="120"></canvas>
        </div>
    </div>
</div>

<!-- Node Performance Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-table me-2"></i>Node Performance Details
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-enhanced table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Node</th>
                                <th>Status</th>
                                <th>Total Commands</th>
                                <th>Success Rate</th>
                                <th>Avg Response Time</th>
                                <th>Last Active</th>
                                <th>Uptime</th>
                            </tr>
                        </thead>
                        <tbody id="node-performance-table">
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="status-dot online me-2"></div>
                                        <strong>WC1</strong>
                                    </div>
                                </td>
                                <td><span class="badge bg-success">Online</span></td>
                                <td>1,247</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                            <div class="progress-bar bg-success" style="width: 98.5%"></div>
                                        </div>
                                        <small>98.5%</small>
                                    </div>
                                </td>
                                <td>42ms</td>
                                <td>2 minutes ago</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                            <div class="progress-bar bg-info" style="width: 99.2%"></div>
                                        </div>
                                        <small>99.2%</small>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="status-dot online me-2"></div>
                                        <strong>WC2</strong>
                                    </div>
                                </td>
                                <td><span class="badge bg-success">Online</span></td>
                                <td>983</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                            <div class="progress-bar bg-success" style="width: 97.8%"></div>
                                        </div>
                                        <small>97.8%</small>
                                    </div>
                                </td>
                                <td>38ms</td>
                                <td>5 minutes ago</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                            <div class="progress-bar bg-info" style="width: 98.7%"></div>
                                        </div>
                                        <small>98.7%</small>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="status-dot offline me-2"></div>
                                        <strong>WC3</strong>
                                    </div>
                                </td>
                                <td><span class="badge bg-secondary">Offline</span></td>
                                <td>756</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                            <div class="progress-bar bg-warning" style="width: 95.2%"></div>
                                        </div>
                                        <small>95.2%</small>
                                    </div>
                                </td>
                                <td>52ms</td>
                                <td>2 hours ago</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                            <div class="progress-bar bg-warning" style="width: 87.3%"></div>
                                        </div>
                                        <small>87.3%</small>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Health Indicators -->
<div class="row">
    <div class="col-lg-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-heart-pulse me-2"></i>System Health
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>CPU Usage</span>
                    <span class="text-success">23%</span>
                </div>
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 23%"></div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Memory Usage</span>
                    <span class="text-info">67%</span>
                </div>
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-info" style="width: 67%"></div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Network Usage</span>
                    <span class="text-warning">45%</span>
                </div>
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-warning" style="width: 45%"></div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <span>Storage Usage</span>
                    <span class="text-primary">12%</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-primary" style="width: 12%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-shield-check me-2"></i>Security Status
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <span>SSL Certificate Valid</span>
                </div>
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <span>Firewall Active</span>
                </div>
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <span>Authentication Enabled</span>
                </div>
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    <span>Rate Limiting: Moderate</span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <span>Backup System Active</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-bell me-2"></i>Recent Alerts
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning alert-sm mb-2">
                    <small>
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Node WC3 has been offline for 2 hours
                    </small>
                </div>
                <div class="alert alert-info alert-sm mb-2">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        High activity detected on WC1 (156 commands/hour)
                    </small>
                </div>
                <div class="alert alert-success alert-sm mb-0">
                    <small>
                        <i class="bi bi-check-circle me-1"></i>
                        System backup completed successfully
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Analytics page functionality
    let charts = {};
    let analyticsData = {};
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('📊 Analytics page initializing...');
        
        // Initialize charts
        initializeAllCharts();
        
        // Setup event listeners
        setupAnalyticsEventListeners();
        
        // Load initial data
        loadAnalyticsData();
        
        // Setup auto-refresh
        setInterval(refreshAnalytics, 300000); // Refresh every 5 minutes
        
        console.log('✅ Analytics page initialized');
    });
    
    function initializeAllCharts() {
        initializeActivityTimelineChart();
        initializeNodeUsageChart();
        initializeHourlyUsageChart();
        initializeResponseTimeChart();
    }
    
    function initializeActivityTimelineChart() {
        const ctx = document.getElementById('activityTimelineChart');
        if (!ctx) return;
        
        // Generate sample data for 24 hours
        const labels = [];
        const commandsData = [];
        const connectionsData = [];
        const errorsData = [];
        
        for (let i = 23; i >= 0; i--) {
            const time = new Date(Date.now() - (i * 60 * 60 * 1000));
            labels.push(time.getHours() + ':00');
            commandsData.push(Math.floor(Math.random() * 50) + 10);
            connectionsData.push(Math.floor(Math.random() * 20) + 5);
            errorsData.push(Math.floor(Math.random() * 5));
        }
        
        charts.activityTimeline = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Commands',
                        data: commandsData,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Connections',
                        data: connectionsData,
                        borderColor: 'rgb(40, 167, 69)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true,
                        hidden: true
                    },
                    {
                        label: 'Errors',
                        data: errorsData,
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true,
                        hidden: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function initializeNodeUsageChart() {
        const ctx = document.getElementById('nodeUsageChart');
        if (!ctx) return;
        
        charts.nodeUsage = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['WC1', 'WC2', 'WC3'],
                datasets: [{
                    data: [45, 35, 20],
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderColor: [
                        'rgb(102, 126, 234)',
                        'rgb(40, 167, 69)',
                        'rgb(255, 193, 7)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function initializeHourlyUsageChart() {
        const ctx = document.getElementById('hourlyUsageChart');
        if (!ctx) return;
        
        const hours = Array.from({length: 24}, (_, i) => i + ':00');
        const usage = [12, 8, 5, 3, 2, 4, 8, 15, 25, 35, 45, 55, 65, 70, 68, 72, 75, 68, 55, 42, 32, 25, 18, 15];
        
        charts.hourlyUsage = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: hours,
                datasets: [{
                    label: 'Commands per Hour',
                    data: usage,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: 'rgb(102, 126, 234)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function initializeResponseTimeChart() {
        const ctx = document.getElementById('responseTimeChart');
        if (!ctx) return;
        
        charts.responseTime = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['0-10ms', '10-20ms', '20-30ms', '30-50ms', '50-100ms', '100ms+'],
                datasets: [{
                    label: 'Response Count',
                    data: [45, 89, 156, 234, 98, 23],
                    borderColor: 'rgb(23, 162, 184)',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function setupAnalyticsEventListeners() {
        // Chart type toggles
        document.querySelectorAll('input[name="activity-chart-type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateActivityChart(this.id);
            });
        });
        
        // Time range selector
        document.getElementById('time-range').addEventListener('change', function() {
            const range = this.value;
            loadAnalyticsData(range);
            WCSystem.NotificationManager.show(`Updated to ${range} view`, 'info', 2000);
        });
    }
    
    function updateActivityChart(type) {
        if (!charts.activityTimeline) return;
        
        // Hide all datasets
        charts.activityTimeline.data.datasets.forEach(dataset => {
            dataset.hidden = true;
        });
        
        // Show selected dataset
        const datasetMap = {
            'commands': 0,
            'connections': 1,
            'errors': 2
        };
        
        if (datasetMap[type] !== undefined) {
            charts.activityTimeline.data.datasets[datasetMap[type]].hidden = false;
        }
        
        charts.activityTimeline.update();
    }
    
    function loadAnalyticsData(timeRange = '24h') {
        // Simulate loading analytics data
        console.log(`📊 Loading analytics data for ${timeRange}...`);
        
        // Update metrics based on time range
        const metrics = {
            '24h': { commands: 234, successful: 230, avgResponse: '45ms', peak: 156 },
            '7d': { commands: 1456, successful: 1432, avgResponse: '42ms', peak: 189 },
            '30d': { commands: 6234, successful: 6156, avgResponse: '48ms', peak: 234 },
            '90d': { commands: 18456, successful: 18123, avgResponse: '51ms', peak: 289 }
        };
        
        const data = metrics[timeRange] || metrics['24h'];
        
        // Update metric displays
        document.getElementById('total-commands').textContent = data.commands.toLocaleString();
        document.getElementById('successful-commands').textContent = data.successful.toLocaleString();
        document.getElementById('avg-response-time').textContent = data.avgResponse;
        document.getElementById('peak-usage').textContent = data.peak;
        
        // Update charts with new data (simplified)
        updateChartsWithNewData(timeRange);
    }
    
    function updateChartsWithNewData(timeRange) {
        // Update activity timeline chart
        if (charts.activityTimeline) {
            // Generate new data based on time range
            const dataPoints = timeRange === '24h' ? 24 : timeRange === '7d' ? 7 : 30;
            const newData = Array.from({length: dataPoints}, () => Math.floor(Math.random() * 50) + 10);
            
            charts.activityTimeline.data.datasets[0].data = newData;
            charts.activityTimeline.update();
        }
        
        // Update other charts similarly...
    }
    
    function refreshAnalytics() {
        const timeRange = document.getElementById('time-range').value;
        WCSystem.NotificationManager.show('Refreshing analytics data...', 'info', 1000);
        
        // Show loading state
        const refreshBtn = document.querySelector('[onclick="refreshAnalytics()"]');
        if (refreshBtn) {
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="loading-spinner"></span> Refreshing...';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                loadAnalyticsData(timeRange);
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
                WCSystem.NotificationManager.show('Analytics data updated', 'success', 2000);
            }, 1500);
        }
    }
    
    // Analytics-specific styles
    const analyticsStyle = document.createElement('style');
    analyticsStyle.textContent = `
        .alert-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .progress {
            background-color: var(--bs-tertiary-bg);
        }
        
        .btn-group .btn-check:checked + .btn {
            background-color: var(--bs-primary);
            color: white;
        }
        
        .chart-container canvas {
            border-radius: 8px;
        }
        
        #node-performance-table .progress {
            height: 8px;
            min-width: 60px;
        }
    `;
    document.head.appendChild(analyticsStyle);
</script>
{% endblock %}
